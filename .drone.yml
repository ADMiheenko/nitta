kind: pipeline
name: default

steps:

  - name: build and test nitta backend
    image: nitta-build:latest
    pull: if-not-exists
    commands:
      - export TASTY_QUICKCHECK_TESTS=100
      - stack setup
      - stack build --test --haddock --copy-bins
      - stack exec nitta-api-gen  # generate REST API library for frontend
      
  - name: build nitta frontend
    image: nitta-build:latest
    pull: if-not-exists
    commands:
      - yarn --cwd web install
      - yarn --cwd web run build

  - name: hardware smoke tests
    image: nitta-build:latest
    pull: if-not-exists
    commands:
      - make -C hdl

  - name: failure-telegram-notify
    image: byrnedo/alpine-curl
    commands:
      - export TIME="10"
      - export URL="https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
      - export CHAT_ID="-1001238497609"
      - export TEXT="build failure branch $DRONE_BRANCH of $DRONE_REPO_NAME https://drone.lcps.nitta.io/nitta-corp/nitta"
      - echo curl -v -s --max-time $TIME -d "chat_id=$CHAT_ID&disable_web_page_preview=1&text=$TEXT" $URL
      - curl -v -s --max-time $TIME -d "chat_id=$CHAT_ID&disable_web_page_preview=1&text=$TEXT" $URL
    when:
      status:
        - failure
    environment:
      TELEGRAM_BOT_TOKEN:
        from_secret: TELEGRAM_BOT_TOKEN

  - name: success-telegram-notify
    image: byrnedo/alpine-curl
    commands:
      - export TIME="10"
      - export URL="https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
      - export CHAT_ID="-1001238497609"
      - export TEXT="build success branch $DRONE_BRANCH of $DRONE_REPO_NAME https://drone.lcps.nitta.io/nitta-corp/nitta"
      - echo curl -v -s --max-time $TIME -d "chat_id=$CHAT_ID&disable_web_page_preview=1&text=$TEXT" $URL
      - curl -v -s --max-time $TIME -d "chat_id=$CHAT_ID&disable_web_page_preview=1&text=$TEXT" $URL
    when:
      status:
        - success
    environment:
      TELEGRAM_BOT_TOKEN:
        from_secret: TELEGRAM_BOT_TOKEN
